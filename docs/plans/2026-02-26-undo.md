# Undo Feature Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add an undo button to the game header that steps back through moves one at a time using a delta/move-record stack.

**Architecture:** Each write to the board pushes a `_Move` record `({row, col, oldValue, newValue})` onto `_undoStack`. Undo pops the top record and restores `oldValue`. All changes are confined to `lib/screens/game_screen.dart`.

**Tech Stack:** Flutter 3.x / Dart 3.x. Use `flutter analyze` to verify correctness (flutter test is broken on this machine due to a network issue with storage.flutter-io.cn).

---

### Task 1: Add `_Move` typedef and `_undoStack` state variable

**Files:**
- Modify: `lib/screens/game_screen.dart`

**Step 1: Add the typedef above the class definition**

In `game_screen.dart`, after the imports and before `class GameScreen`, add:

```dart
typedef _Move = ({int row, int col, int oldValue, int newValue});
```

**Step 2: Add `_undoStack` field inside `_GameScreenState`**

After the `String? _hintMessage;` field (line ~31), add:

```dart
final List<_Move> _undoStack = [];
```

**Step 3: Clear the stack in `_newGame()`**

Inside `_newGame()`, after `_hintMessage = null;`, add:

```dart
_undoStack.clear();
```

**Step 4: Analyze**

```bash
flutter analyze
```

Expected: no new errors or warnings.

**Step 5: Commit**

```bash
git add lib/screens/game_screen.dart
git commit -m "feat(undo): add _Move typedef and _undoStack field"
```

---

### Task 2: Push moves in `_onNumberInput` and `_onErase`

**Files:**
- Modify: `lib/screens/game_screen.dart`

**Step 1: Update `_onNumberInput` to push before writing**

The current body of `_onNumberInput` is:
```dart
setState(() {
  _board[_selectedRow][_selectedCol] = num;
  _updateErrors();
  ...
```

Capture the old value and push *before* writing:
```dart
void _onNumberInput(int num) {
  if (_isPaused || _isAnimating || _isCompleted) return;
  if (_selectedRow < 0 || _selectedCol < 0) return;
  if (_isGiven[_selectedRow][_selectedCol]) return;
  setState(() {
    _undoStack.add((
      row: _selectedRow,
      col: _selectedCol,
      oldValue: _board[_selectedRow][_selectedCol],
      newValue: num,
    ));
    _board[_selectedRow][_selectedCol] = num;
    _updateErrors();
    if (_checkWin()) {
      _isCompleted = true;
      _timer?.cancel();
      _showWinDialog();
    }
  });
}
```

**Step 2: Update `_onErase` to push before writing**

```dart
void _onErase() {
  if (_isPaused || _isAnimating || _isCompleted) return;
  if (_selectedRow < 0 || _selectedCol < 0) return;
  if (_isGiven[_selectedRow][_selectedCol]) return;
  setState(() {
    _undoStack.add((
      row: _selectedRow,
      col: _selectedCol,
      oldValue: _board[_selectedRow][_selectedCol],
      newValue: 0,
    ));
    _board[_selectedRow][_selectedCol] = 0;
    _updateErrors();
  });
}
```

**Step 3: Analyze**

```bash
flutter analyze
```

Expected: no new errors or warnings.

**Step 4: Commit**

```bash
git add lib/screens/game_screen.dart
git commit -m "feat(undo): push moves from _onNumberInput and _onErase"
```

---

### Task 3: Push move in `_runHiddenSingleHint`

**Files:**
- Modify: `lib/screens/game_screen.dart`

**Step 1: Find the fill step at the end of `_runHiddenSingleHint`**

The final `setState` in `_runHiddenSingleHint` contains:
```dart
_board[result.row][result.col] = result.digit;
```

Add the push immediately before that line:
```dart
_undoStack.add((
  row: result.row,
  col: result.col,
  oldValue: 0,
  newValue: result.digit,
));
_board[result.row][result.col] = result.digit;
```

Note: the hint target cell is always empty (0) before the hint fills it, so `oldValue: 0` is correct.

**Step 2: Analyze**

```bash
flutter analyze
```

Expected: no new errors or warnings.

**Step 3: Commit**

```bash
git add lib/screens/game_screen.dart
git commit -m "feat(undo): push hint move from _runHiddenSingleHint"
```

---

### Task 4: Implement `_undo()` method

**Files:**
- Modify: `lib/screens/game_screen.dart`

**Step 1: Add `_undo()` after `_onErase()`**

```dart
void _undo() {
  if (_undoStack.isEmpty || _isPaused || _isAnimating || _isCompleted) return;
  setState(() {
    final move = _undoStack.removeLast();
    _board[move.row][move.col] = move.oldValue;
    _selectedRow = move.row;
    _selectedCol = move.col;
    _updateErrors();
  });
}
```

**Step 2: Analyze**

```bash
flutter analyze
```

Expected: no new errors or warnings.

**Step 3: Commit**

```bash
git add lib/screens/game_screen.dart
git commit -m "feat(undo): implement _undo() method"
```

---

### Task 5: Add undo button to the header

**Files:**
- Modify: `lib/screens/game_screen.dart`

**Step 1: Find `_buildHeader()`**

The header `Row` currently starts with a back `IconButton` followed by an `Expanded` title column. Add the undo button between the back button and the `Expanded` title:

```dart
IconButton(
  icon: const Icon(Icons.undo),
  onPressed: (_undoStack.isEmpty || _isPaused || _isAnimating || _isCompleted)
      ? null
      : _undo,
  color: const Color(0xFF1A237E),
),
```

Place it immediately after the back `IconButton` (the one with `Icons.arrow_back_ios_new`).

**Step 2: Analyze**

```bash
flutter analyze
```

Expected: no new errors or warnings.

**Step 3: Commit**

```bash
git add lib/screens/game_screen.dart
git commit -m "feat(undo): add undo button to game header"
```
